<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<title>Se vira parceiro (a)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  /* Temas */
  body.tema-escuro {
    background: #181818;
    color: #e0e0e0;
  }
  body.tema-claro {
    background: #f4f4f4;
    color: #222;
  }
  body.tema-pastel {
    background: #ffe0e9;
    color: #4c4c4c;
  }

  /* Fonte e transi√ß√µes */
  body, textarea, input, select, button, label {
    font-family: 'Segoe UI', sans-serif;
    transition: all 0.3s ease;
  }

  /* Layout compacto */
  section {
    background: #222;
    color: #e0e0e0;
    padding: 12px 15px;
    border-radius: 8px;
    margin-bottom: 12px;
  }
  body.tema-claro section {
    background: #fff;
    color: #222;
  }
  body.tema-pastel section {
    background: #fffaf0;
    color: #333;
  }

  h1, h2 {
    text-align: center;
    color: #80dfff;
    margin: 10px 0 15px 0;
  }

  #temaSelectorContainer {
    text-align: center;
    margin: 12px 0;
  }
  #temaSelectorContainer label {
    font-weight: 700;
    margin-right: 6px;
  }
  #temaSelectorContainer select {
    padding: 4px 8px;
    font-size: 14px;
  }

  /* Inputs e selects menores */
  input[type="text"],
  input[type="number"],
  select,
  textarea {
    width: 100%;
    padding: 6px 8px;
    margin: 4px 0 8px 0;
    font-size: 13px;
    border-radius: 5px;
    border: 1px solid #666;
    box-sizing: border-box;
    color: inherit;
    background: transparent;
  }
  body.tema-claro input,
  body.tema-claro select,
  body.tema-claro textarea {
    border-color: #aaa;
    background: #fff;
    color: #222;
  }
  body.tema-pastel input,
  body.tema-pastel select,
  body.tema-pastel textarea {
    border-color: #c5b1a2;
    background: #fffaf0;
    color: #333;
  }

  /* Bot√µes menores e alinhados */
  button {
    background: #80dfff;
    color: #000;
    border: none;
    padding: 6px 12px;
    font-size: 14px;
    border-radius: 6px;
    cursor: pointer;
    margin-top: 8px;
    transition: background-color 0.2s ease;
  }
  button:hover {
    background: #4ac6e0;
  }

  /* Layout flex para inputs e bot√µes juntos */
  .flex-row {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    align-items: center;
  }
  .flex-grow {
    flex-grow: 1;
  }

  /* Tabelas compactas */
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 6px;
  }
  th, td {
    padding: 5px 8px;
    border: 1px solid #555;
    font-size: 13px;
    text-align: left;
  }
  body.tema-claro th, body.tema-claro td {
    border-color: #ccc;
  }

  /* Bot√µes pequenos nas tabelas */
  .btn-small {
    padding: 3px 7px;
    font-size: 12px;
    border-radius: 4px;
    margin-right: 4px;
  }
  .btn-edit {
    background: #ffcc00;
    color: #222;
  }
  .btn-delete {
    background: #ff5555;
    color: #fff;
  }

  /* Labels inline com checkbox */
  label.checkbox-inline {
    display: flex;
    align-items: center;
    gap: 0.4em;
    margin-top: 8px;
    font-size: 14px;
  }

  /* Pre formatado compacto */
  pre {
    background: #111;
    padding: 10px;
    border-radius: 6px;
    white-space: pre-wrap;
    font-size: 13px;
    max-height: 140px;
    overflow-y: auto;
    color: inherit;
    margin-top: 8px;
  }

  /* Footer compacto */
  footer {
    text-align: center;
    color: #888;
    font-size: 11px;
    margin-top: 25px;
    background: #111;
    padding: 0.7em 0;
    border-top: 1px solid #333;
    user-select: none;
  }
  footer a {
    color: #7FDBFF;
    text-decoration: none;
    transition: color 0.3s;
  }
  footer a:hover {
    color: #4ac6e0;
  }

  /* Feedback gera√ß√£o arquivo */
  #resultadoDownload {
    margin-top: 12px;
    font-weight: 600;
    font-size: 14px;
    color: #7FDBFF;
    min-height: 1.3em;
  }
</style>
</head>
<body class="tema-claro">

<h1>üë®‚Äçüè´ CorregePtx‚Ñ¢</h1>
<p style="text-align:center; font-style:italic; margin-bottom:20px;">Plataforma de Corre√ß√£o para Quem J√° Desistiu de Acreditar.</p>

<div id="temaSelectorContainer">
  <label for="temaSelect">Tema:</label>
  <select id="temaSelect" onchange="mudarTema(this.value)">
    <option value="escuro">Escuro</option>
    <option value="claro">Claro</option>
    <option value="pastel">Pastel</option>
  </select>
</div>

<!-- Se√ß√£o Turmas -->
<section>
  <h2>Gerenciar Turmas</h2>
  <div class="flex-row">
    <input type="text" id="inputTurma" placeholder="Nome da turma (ex: 3¬∫ ano A)" class="flex-grow" autocomplete="off" />
    <button onclick="addTurma()" title="Adicionar turma">Adicionar</button>
  </div>
  <table id="tabelaTurmas" aria-label="Lista de turmas">
    <thead>
      <tr><th>Turma</th><th>A√ß√µes</th></tr>
    </thead>
    <tbody></tbody>
  </table>
</section>

<!-- Se√ß√£o Alunos -->
<section>
  <h2>Gerenciar Alunos</h2>
  <div class="flex-row">
    <select id="selectTurmasForAluno" class="flex-grow" aria-label="Selecione turma para adicionar aluno" title="Selecione uma turma">
      <option value="">-- Selecione uma turma --</option>
    </select>
    <input type="text" id="inputAluno" placeholder="Nome do aluno" class="flex-grow" autocomplete="off" />
    <button onclick="addAluno()" title="Adicionar aluno">Adicionar</button>
  </div>
  <table id="tabelaAlunos" aria-label="Lista de alunos">
    <thead>
      <tr><th>Turma</th><th>Aluno</th><th>A√ß√µes</th></tr>
    </thead>
    <tbody></tbody>
  </table>
</section>

<!-- Se√ß√£o Corre√ß√£o Objetiva -->
<section>
  <h2>Parte Objetiva</h2>
  <label for="gabarito">Gabarito (ex: A,B,C,D,E):</label>
  <input type="text" id="gabarito" placeholder="Digite o gabarito separado por v√≠rgulas" autocomplete="off" />
  
  <label for="notaMaxObjetiva">Nota m√°xima da prova objetiva:</label>
  <input type="number" id="notaMaxObjetiva" value="10" min="1" step="0.1" autocomplete="off" />
  
  <label for="respostas">Respostas dos alunos (ex: Jo√£o,A,B,C,D,E):</label>
  <textarea id="respostas" rows="5" placeholder="Um por linha, come√ßando pelo nome." autocomplete="off"></textarea>
  
  <div class="flex-row" style="gap: 8px;">
    <button onclick="corrigirObjetiva()">Corrigir Objetivas</button>
    <button onclick="limparResultado('resultadoObjetiva')">Limpar Resultado</button>
  </div>
  <pre id="resultadoObjetiva">-- Resultados aparecer√£o aqui --</pre>
</section>

<!-- Se√ß√£o Corre√ß√£o Dissertativa -->
<section>
  <h2>Parte Dissertativa</h2>
  <label for="palavrasChave">Palavras-chave esperadas (ex: fotoss√≠ntese, luz, energia):</label>
  <input type="text" id="palavrasChave" placeholder="Separe por v√≠rgulas" autocomplete="off" />
  
  <label for="notaMaxDissertativa">Nota m√°xima da prova dissertativa:</label>
  <input type="number" id="notaMaxDissertativa" value="10" min="1" step="0.1" autocomplete="off" />
  
  <label for="respostasDissertativas">Respostas dos alunos (ex: Jo√£o,A resposta √©...):</label>
  <textarea id="respostasDissertativas" rows="5" placeholder="Um por linha, com nome e resposta" autocomplete="off"></textarea>
  
  <div class="flex-row" style="gap: 8px;">
    <button onclick="corrigirDissertativa()">Corrigir Dissertativas</button>
    <button onclick="limparResultado('resultadoDissertativa')">Limpar Resultado</button>
  </div>
  <pre id="resultadoDissertativa">-- Resultados aparecer√£o aqui --</pre>
</section>

<!-- Se√ß√£o Relat√≥rio -->
<section>
  <h2>Gerar Relat√≥rio da Corre√ß√£o</h2>
  <label for="selectTurmasForCorrecao">Selecionar Turma:</label>
  <select id="selectTurmasForCorrecao" aria-label="Selecionar turma para corre√ß√£o" title="Selecione uma turma">
    <option value="">-- Selecione uma turma --</option>
  </select>
  <label for="selectAlunosForCorrecao">Selecionar Aluno:</label>
  <select id="selectAlunosForCorrecao" aria-label="Selecionar aluno para corre√ß√£o" title="Selecione um aluno">
    <option value="">-- Selecione um aluno --</option>
  </select>
  <label for="inputNotaCorrecao">Nota da prova (0 a 10):</label>
  <input type="number" id="inputNotaCorrecao" min="0" max="10" step="0.1" autocomplete="off" />
  <label for="inputComentario">Coment√°rio (opcional):</label>
  <textarea id="inputComentario" rows="2" placeholder="Digite um coment√°rio para o aluno..." autocomplete="off"></textarea>
  <label class="checkbox-inline" for="chkDataHora">
    <input type="checkbox" id="chkDataHora" /> Incluir data e hora da corre√ß√£o no relat√≥rio
  </label>
  <div class="flex-row" style="gap:8px; margin-top: 8px;">
    <button onclick="gerarPDF()" style="flex:1;" title="Gerar arquivo PDF">Gerar PDF</button>
    <button onclick="gerarDOCX()" style="flex:1;" title="Gerar arquivo DOCX">Gerar DOCX</button>
  </div>
  <div id="resultadoDownload" aria-live="polite"></div>
</section>

<footer>
  <p>üß™ CorregePtx‚Ñ¢ ‚Äî Sistema de Corre√ß√£o Instant√¢nea desde que a paci√™ncia acabou.</p>
  <p>üí∞ Apoie com um Pix simb√≥lico:<br /><strong>biel.simeone@gmail.com</strong></p>
  <p> v2.1 ‚Ä¢ Livre para uso, abuso e aperfei√ßoamento.</p>
</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/docx/7.0.1-beta.6/docx.min.js"></script>
<script>
  // Dados locais turmas e alunos
  let turmas = JSON.parse(localStorage.getItem('turmas') || '[]');
  let alunos = JSON.parse(localStorage.getItem('alunos') || '[]');

  function salvarDados() {
    localStorage.setItem('turmas', JSON.stringify(turmas));
    localStorage.setItem('alunos', JSON.stringify(alunos));
  }

  // Tema
  function mudarTema(tema) {
    document.body.className = '';
    if (tema === 'claro') document.body.classList.add('tema-claro');
    else if (tema === 'pastel') document.body.classList.add('tema-pastel');
    else document.body.classList.add('tema-escuro');
    localStorage.setItem('temaPreferido', tema);
  }

  // Inicializar tema e dados
  window.onload = function () {
    const temaSalvo = localStorage.getItem('temaPreferido') || 'escuro';
    document.getElementById('temaSelect').value = temaSalvo;
    mudarTema(temaSalvo);
    atualizarSelectsTurmas();
    atualizarSelectAlunosParaGerar();
    renderizarListas();
  };

  function atualizarSelectsTurmas() {
    const selects = [
      document.getElementById('selectTurmasForAluno'),
      document.getElementById('selectTurmasForCorrecao')
    ];
    selects.forEach(sel => {
      sel.innerHTML = '<option value="">-- Selecione uma turma --</option>';
      turmas.forEach(t => {
        const option = document.createElement('option');
        option.value = t;
        option.textContent = t;
        sel.appendChild(option);
      });
    });
  }

  function atualizarSelectAlunosParaGerar() {
    const turma = document.getElementById('selectTurmasForCorrecao').value;
    const selectAlunos = document.getElementById('selectAlunosForCorrecao');
    selectAlunos.innerHTML = '<option value="">-- Selecione um aluno --</option>';
    if (!turma) return;
    alunos.filter(a => a.turma === turma)
      .forEach(a => {
        const option = document.createElement('option');
        option.value = a.nome;
        option.textContent = a.nome;
        selectAlunos.appendChild(option);
      });
  }

  // Renderizar listas turmas e alunos
  function renderizarListas() {
    const tbodyTurmas = document.getElementById('tabelaTurmas').querySelector('tbody');
    const tbodyAlunos = document.getElementById('tabelaAlunos').querySelector('tbody');
    tbodyTurmas.innerHTML = '';
    tbodyAlunos.innerHTML = '';

    turmas.forEach((t, i) => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${t}</td>
        <td>
          <button class="btn-small btn-edit" onclick="editarTurma(${i})" title="Editar turma">&#9998;</button>
          <button class="btn-small btn-delete" onclick="excluirTurma(${i})" title="Excluir turma">&#10060;</button>
        </td>
      `;
      tbodyTurmas.appendChild(tr);
    });

    alunos.forEach((a, i) => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${a.turma}</td>
        <td>${a.nome}</td>
        <td>
          <button class="btn-small btn-edit" onclick="editarAluno(${i})" title="Editar aluno">&#9998;</button>
          <button class="btn-small btn-delete" onclick="excluirAluno(${i})" title="Excluir aluno">&#10060;</button>
        </td>
      `;
      tbodyAlunos.appendChild(tr);
    });
  }

  // Adicionar turma
  function addTurma() {
    const nome = document.getElementById('inputTurma').value.trim();
    if (!nome) return alert('Digite o nome da turma');
    if (turmas.includes(nome)) return alert('Essa turma j√° existe');
    turmas.push(nome);
    salvarDados();
    atualizarSelectsTurmas();
    renderizarListas();
    document.getElementById('inputTurma').value = '';
  }

  // Adicionar aluno
  function addAluno() {
    const turma = document.getElementById('selectTurmasForAluno').value;
    const nome = document.getElementById('inputAluno').value.trim();
    if (!turma) return alert('Selecione uma turma');
    if (!nome) return alert('Digite o nome do aluno');
    if (alunos.some(a => a.nome === nome && a.turma === turma)) return alert('Aluno j√° cadastrado nessa turma');
    alunos.push({ turma, nome });
    salvarDados();
    renderizarListas();
    document.getElementById('inputAluno').value = '';
  }

  // Editar turma
  function editarTurma(index) {
    const novoNome = prompt('Digite o novo nome da turma:', turmas[index]);
    if (!novoNome) return;
    if (turmas.includes(novoNome)) return alert('J√° existe uma turma com esse nome');
    const antigoNome = turmas[index];
    turmas[index] = novoNome;
    alunos = alunos.map(a => a.turma === antigoNome ? {...a, turma: novoNome} : a);
    salvarDados();
    atualizarSelectsTurmas();
    renderizarListas();
    atualizarSelectAlunosParaGerar();
  }

  // Excluir turma
  function excluirTurma(index) {
    if (!confirm('Excluir turma e todos os alunos dela?')) return;
    const nome = turmas[index];
    turmas.splice(index, 1);
    alunos = alunos.filter(a => a.turma !== nome);
    salvarDados();
    atualizarSelectsTurmas();
    renderizarListas();
    atualizarSelectAlunosParaGerar();
  }

  // Editar aluno
  function editarAluno(index) {
    const novoNome = prompt('Digite o novo nome do aluno:', alunos[index].nome);
    if (!novoNome) return;
    const turma = alunos[index].turma;
    if (alunos.some((a, i) => i !== index && a.nome === novoNome && a.turma === turma)) return alert('Aluno j√° existe nessa turma');
    alunos[index].nome = novoNome;
    salvarDados();
    renderizarListas();
    atualizarSelectAlunosParaGerar();
  }

  // Excluir aluno
  function excluirAluno(index) {
    if (!confirm('Excluir aluno?')) return;
    alunos.splice(index, 1);
    salvarDados();
    renderizarListas();
    atualizarSelectAlunosParaGerar();
  }

  // Corre√ß√£o Objetiva
  function corrigirObjetiva() {
    const gabarito = document.getElementById('gabarito').value.trim().toUpperCase();
    const respostasRaw = document.getElementById('respostas').value.trim();
    const notaMax = parseFloat(document.getElementById('notaMaxObjetiva').value);

    if (!gabarito) return alert('Informe o gabarito da prova objetiva.');
    if (!respostasRaw) return alert('Informe as respostas dos alunos na parte objetiva.');
    if (isNaN(notaMax) || notaMax <= 0) return alert('Informe uma nota m√°xima v√°lida para a prova objetiva.');

    const gabaritoArr = gabarito.split(',').map(s => s.trim());
    const linhas = respostasRaw.split('\n').filter(l => l.trim());
    const resultados = [];

    linhas.forEach((linha, i) => {
      const partes = linha.split(',');
      const nome = partes[0].trim();
      const respostas = partes.slice(1).map(s => s.trim().toUpperCase());
      if (!nome || respostas.length !== gabaritoArr.length) {
        resultados.push(`${nome || `Linha ${i+1}`}: formato inv√°lido ou n√∫mero de respostas n√£o bate com o gabarito.`);
        return;
      }
      let acertos = 0;
      for (let j=0; j < gabaritoArr.length; j++) {
        if (respostas[j] === gabaritoArr[j]) acertos++;
      }
      // Nota proporcional:
      const nota = (acertos / gabaritoArr.length) * notaMax;
      resultados.push(`${nome}: ${acertos}/${gabaritoArr.length} acertos ‚Äî Nota: ${nota.toFixed(2)} / ${notaMax}`);
    });

    document.getElementById('resultadoObjetiva').textContent = resultados.join('\n');
  }

  // Limpar resultado
  function limparResultado(id) {
    document.getElementById(id).textContent = '-- Resultados aparecer√£o aqui --';
  }

  // Corre√ß√£o Dissertativa
  function corrigirDissertativa() {
    const palavrasRaw = document.getElementById('palavrasChave').value.trim().toLowerCase();
    const respostasRaw = document.getElementById('respostasDissertativas').value.trim();
    const notaMax = parseFloat(document.getElementById('notaMaxDissertativa').value);

    if (!palavrasRaw) return alert('Informe as palavras-chave para a corre√ß√£o dissertativa.');
    if (!respostasRaw) return alert('Informe as respostas dissertativas dos alunos.');
    if (isNaN(notaMax) || notaMax <= 0) return alert('Informe uma nota m√°xima v√°lida para a prova dissertativa.');

    const palavras = palavrasRaw.split(',').map(p => p.trim()).filter(p => p);
    if (palavras.length === 0) return alert('Informe ao menos uma palavra-chave v√°lida.');

    const linhas = respostasRaw.split('\n').filter(l => l.trim());
    const resultados = [];

    linhas.forEach((linha, i) => {
      const idxVirgula = linha.indexOf(',');
      if (idxVirgula < 1) {
        resultados.push(`Linha ${i+1}: formato inv√°lido, deve conter "Nome, resposta".`);
        return;
      }
      const nome = linha.slice(0, idxVirgula).trim();
      const resposta = linha.slice(idxVirgula+1).toLowerCase();

      if (!nome || !resposta) {
        resultados.push(`Linha ${i+1}: nome ou resposta inv√°lidos.`);
        return;
      }

      let encontrados = 0;
      palavras.forEach(p => {
        if (resposta.includes(p)) encontrados++;
      });

      const nota = (encontrados / palavras.length) * notaMax;
      resultados.push(`${nome}: ${encontrados} / ${palavras.length} palavras-chave encontradas ‚Äî Nota: ${nota.toFixed(2)} / ${notaMax}`);
    });

    document.getElementById('resultadoDissertativa').textContent = resultados.join('\n');
  }

  // Gerar relat√≥rio PDF usando jsPDF
  async function gerarPDF() {
    try {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      const turma = document.getElementById('selectTurmasForCorrecao').value;
      const aluno = document.getElementById('selectAlunosForCorrecao').value;
      const nota = document.getElementById('inputNotaCorrecao').value;
      const comentario = document.getElementById('inputComentario').value.trim();
      const incluirDataHora = document.getElementById('chkDataHora').checked;

      if (!turma || !aluno) return alert('Selecione turma e aluno para gerar relat√≥rio.');
      if (!nota || isNaN(parseFloat(nota)) || parseFloat(nota) < 0) return alert('Informe uma nota v√°lida.');

      const dataCorr = incluirDataHora ? new Date().toLocaleString() : '';

      doc.setFontSize(18);
      doc.setTextColor('#80dfff');
      doc.text("Relat√≥rio de Corre√ß√£o", 105, 20, null, null, 'center');
      doc.setFontSize(12);
      doc.setTextColor('#222');

      doc.text(`Turma: ${turma}`, 20, 40);
      doc.text(`Aluno: ${aluno}`, 20, 50);
      doc.text(`Nota: ${nota}`, 20, 60);
      if (comentario) doc.text("Coment√°rio:", 20, 70);

      if (comentario) {
        const splitComentario = doc.splitTextToSize(comentario, 170);
        doc.text(splitComentario, 20, 80);
      }

      if (dataCorr) {
        doc.setFontSize(10);
        doc.setTextColor('#888');
        doc.text(`Gerado em: ${dataCorr}`, 105, 290, null, null, 'center');
      }

      doc.save(`Relatorio_${aluno}_${turma}.pdf`);
      document.getElementById('resultadoDownload').textContent = `PDF gerado para ${aluno} (${turma})`;
    } catch (err) {
      alert('Erro ao gerar PDF: ' + err.message);
    }
  }

  // Gerar relat√≥rio DOCX usando docx.js
  async function gerarDOCX() {
    try {
      const { Document, Packer, Paragraph, TextRun } = docx;

      const turma = document.getElementById('selectTurmasForCorrecao').value;
      const aluno = document.getElementById('selectAlunosForCorrecao').value;
      const nota = document.getElementById('inputNotaCorrecao').value;
      const comentario = document.getElementById('inputComentario').value.trim();
      const incluirDataHora = document.getElementById('chkDataHora').checked;

      if (!turma || !aluno) return alert('Selecione turma e aluno para gerar relat√≥rio.');
      if (!nota || isNaN(parseFloat(nota)) || parseFloat(nota) < 0) return alert('Informe uma nota v√°lida.');

      const dataCorr = incluirDataHora ? new Date().toLocaleString() : '';

      const doc = new Document({
        sections: [{
          properties: {},
          children: [
            new Paragraph({
              text: "Relat√≥rio de Corre√ß√£o",
              heading: "Title",
              thematicBreak: true
            }),
            new Paragraph(`Turma: ${turma}`),
            new Paragraph(`Aluno: ${aluno}`),
            new Paragraph(`Nota: ${nota}`),
            ...(comentario ? [new Paragraph("Coment√°rio:"), new Paragraph(comentario)] : []),
            ...(dataCorr ? [new Paragraph(`Gerado em: ${dataCorr}`)] : [])
          ],
        }],
      });

      const blob = await Packer.toBlob(doc);
      const nomeArquivo = `Relatorio_${aluno}_${turma}.docx`;

      // Criar link para download
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = nomeArquivo;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);

      document.getElementById('resultadoDownload').textContent = `DOCX gerado para ${aluno} (${turma})`;
    } catch (err) {
      alert('Erro ao gerar DOCX: ' + err.message);
    }
  }

  // Atualizar alunos ao mudar turma no relat√≥rio
  document.getElementById('selectTurmasForCorrecao').addEventListener('change', () => {
    atualizarSelectAlunosParaGerar();
  });
</script>

</body>
</html>
